{"version":3,"sources":["../../../server/custom_modules/node-ig-api-interface/node-ig-api.js"],"names":["https","require","path","appDir","dirname","main","filename","IGmarkets","Prices","requirejs","config","deps","nodeRequire","pidCrypt","pidCryptUtil","lsClient","subscription","setEnvVars","token","xst","cst","ls_endpoint","process","env","IG_TOKENS_EXP","IG_XST","IG_CST","IG_LIGHTSTREAMER_END_POINT","tokenExists","saveTokenToDB","igMarkets","console","log","updateOne","_id","then","res","nModified","save","initiateToken","find","conn","tokens_exp","Date","getTime","lightstreamerEndpoint","e","demo","IG_DEMO","tokensNull","_request","method","payload","extraHeaders","headers","IG_API_KEY","encodedPayload","JSON","stringify","Buffer","byteLength","Object","assign","reqOpts","hostname","Promise","resolve","reject","req","request","status","statusCode","body","on","data","toString","length","parse","write","end","_pwdEncrypter","password","encryptionKey","timestamp","rsa","RSA","decodedKey","decodeBase64","asn","ASN1","decode","toByteArray","tree","toHexTree","setPublicKeyFromASN","encodeBase64","convertFromHex","encrypt","reqMethod","type","url","version","indexOf","login","encryption","rej","tokens","r","identifier","IG_IDENTIFIER","IG_PASSWORD","timeStamp","encryptedPassword","currentAccountId","result","logout","switchAcct","accountId","acctInfo","acctActivity","from","to","detailed","dealId","pageSize","dateReg","test","Error","qstring","acctTransaction","pageNumber","apiInfo","showOpenPositions","deal","ticket","currencyCode","direction","epic","expiry","size","forceOpen","orderType","guaranteedStop","limitDistance","limitLevel","stopDistance","stopLevel","timeInForce","level","trailingStopIncrement","trailingStop","response","positions","dealReference","confirms","editPosition","dial_id","closePosition","temp1","temp2","i","position","market","currency","marketStatus","streamingPricesAvailable","bid","offer","closeAllPositions","tickets","index","temp","push","_close","showWorkingOrders","createOrder","deleteOrder","close","workingorders","deleteAllOrders","workingOrders","workingOrderData","search","searchTerm","igVolume","epics","qstringEpics","map","slice","marketDetails","qstringMaketId","instrument","marketId","marketNode","id","histPrc","resolution","epicDetails","watchlists","createWatchlist","name","deleteWatchlist","addEpicWatchlist","watchlistID","removeEpicWatchlist","connectToLightstreamer","LightstreamerClient","connectionDetails","setUser","IG_CURRENT_ACCT_ID","setPassword","addListener","onListenStart","onStatusChange","onServerError","errorCode","errorMessage","connect","subscribeToLightstreamer","subscriptionMode","items","fields","maxFreq","getOwnPropertyNames","Subscription","str","colNames","concat","setRequestedMaxFrequency","onSubscription","onUnsubscription","onSubscriptionError","code","message","onItemLostUpdates","onItemUpdate","updateInfo","coeff","date","rounded","Math","round","epic_settings","By","forEachField","fieldName","fieldPos","value","price","CONS_END","UTM","BID_CLOSE","subscribe","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\n/****\n * Not written by Mark Ooi\n * NPM node-ig-api with some edits\n * \n */\n\nconst https = require('https');\nconst path = require('path');\nvar appDir = path.dirname(require.main.filename);\n\n// IG API Model\nconst IGmarkets = require('../../models/IGmarkets');\nconst Prices = require('../../models/Prices');\n\n// required for Lighstreamer\nconst requirejs = require('requirejs');\nrequirejs.config({\n\tdeps: [appDir + '/node_modules/node-ig-api/lib/lightstreamer.js'],\n\t// v6.2.6 build 1678 - https://labs.ig.com/lightstreamer-downloads\n\t// http://www.lightstreamer.com/repo/distros/Lightstreamer_Allegro-Presto-Vivace_6_0_1_20150730.zip%23/Lightstreamer/DOCS-SDKs/sdk_client_javascript/doc/API-reference/index.html\n\tnodeRequire: require\n});\n\n// required for IG psw encryption\nrequire(appDir + '/node_modules/node-ig-api/lib/seedrandom');\nrequire(appDir + '/node_modules/node-ig-api/lib/rsa');\nrequire(appDir + '/node_modules/node-ig-api/lib/asn1');\nconst pidCrypt = require(appDir + '/node_modules/node-ig-api/lib');\nconst pidCryptUtil = require(appDir + '/node_modules/node-ig-api/lib/pidcrypt_util');\n\nvar lsClient;\nvar subscription;\n\n/***\n * (Helper function)\n * \n */\n\nfunction setEnvVars(token = 0, xst = '', cst = '', ls_endpoint = '') {\n\tprocess.env.IG_TOKENS_EXP = token;\n\tprocess.env.IG_XST = xst;\n\tprocess.env.IG_CST = cst;\n\tprocess.env.IG_LIGHTSTREAMER_END_POINT = ls_endpoint;\n}\n\n/***\n * (Helper function)\n * IG auth tokens are saved in the DB. If one exists, but is expired, it is overwritten.\n * Otherwise, a new one is created.\n * \n */\n\nlet tokenExists = true;\n\nasync function saveTokenToDB(igMarkets) {\n\t\n\tif(tokenExists) {\n\t\tconsole.log(\"Attempting to update token in DB\");\n\t\treturn await IGmarkets.updateOne({_id:1}, igMarkets)\n\t\t\t.then(res => {\n\t\t\t\tconsole.log('Token update result: ',res.nModified);\n\t\t\t});\n\t} else {\n\t\tconsole.log(\"Attempting to insert new token in DB\");\n\t\treturn await igMarkets.save()\n\t\t\t.then(res => {\n\t\t\t\tconsole.log('Token insert result (id): ',res._id);\n\t\t\t});\n\t}\n}\n\n/***\n * [First function]\n * Check the state of the token.\n * \n */\n\nasync function initiateToken() {\n\treturn await IGmarkets.find({_id:1})\n\t\t.then(conn => {\n\t\t\tif(conn[0].tokens_exp > new Date().getTime() ) {\n\t\t\t\tconsole.log('token valid, continuing');\n\t\t\t\tsetEnvVars(conn[0].tokens_exp,conn[0]['x-security-token'],conn[0].cst,conn[0].lightstreamerEndpoint);\n\t\t\t} else {\n\t\t\t\tconsole.log('token expired, resetting');\n\t\t\t\tsetEnvVars();\n\t\t\t}\n\t\t\ttokenExists = true;\t\n\t\t})\n\t\t.catch(e => {\n\t\t\tconsole.log('no token found, resetting');\n\t\t\tsetEnvVars();\n\t\t\ttokenExists = false;\n\t\t});\n}\n\nvar demo = process.env.IG_DEMO==='TRUE'?true:false;\n\nvar tokensNull = {\n\t'tokens_exp': 0,\n\t'x-request-id': '',\n\t'x-security-token': '',\n\t'cst': '',\n\t'lightstreamerEndpoint': '',\n\t'currentAccountId': ''\n};\n\nvar lsClient = {};\nvar subscription = {};\n\n\n///////////////////////////////\n// GENERIC IG REST REQUESTER //\n///////////////////////////////\n\n// Generic REST client for the IG trading API\nfunction _request(method, path, payload, extraHeaders) {\n\n\tlet headers = {\n\t\t'Content-Type': 'application/json; charset=UTF-8',\n\t\t'Accept': 'application/json; charset=UTF-8',\n\t\t'X-IG-API-KEY': process.env.IG_API_KEY\n\t};\n\tlet encodedPayload = '';\n\tif (payload) {\n\t\tencodedPayload = JSON.stringify(payload);\n\t\theaders['Content-Length'] = Buffer.byteLength(encodedPayload);\n\t}\n\tif (extraHeaders) {\n\t\theaders = Object.assign(headers, extraHeaders);\n\t}\n\tlet reqOpts = {\n\t\thostname: demo ? 'demo-api.ig.com' : 'api.ig.com',\n\t\tpath: '/gateway/deal' + path,\n\t\tmethod,\n\t\theaders,\n\t};\n\t\n\treturn new Promise((resolve, reject) => {\n\t\tlet req = https.request(reqOpts, res => {\n\t\t\tlet status = res.statusCode;\n\t\t\tlet headers = res.headers;\n\t\t\tlet body = '';\n\t\t\tres.on('data', data => {\n\t\t\t\tbody += data.toString('utf8');\n\t\t\t});\n\t\t\tres.on('end', () => {\n\t\t\t\ttry {\n\t\t\t\t\tresolve({\n\t\t\t\t\t\tstatus,\n\t\t\t\t\t\theaders,\n\t\t\t\t\t\tbody: body.length === 0 ? {} : JSON.parse(body) // cannot parse an empty body\n\t\t\t\t\t});\n\t\t\t\t} catch (e) {\n\t\t\t\t\treject({\n\t\t\t\t\t\tstatus,\n\t\t\t\t\t\theaders,\n\t\t\t\t\t\te\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\treq.on('error', e => {\n\t\t\treject({\n\t\t\t\tstatus,\n\t\t\t\theaders,\n\t\t\t\te\n\t\t\t});\n\t\t});\n\t\tif (method !== 'GET') {\n\t\t\treq.write(encodedPayload);\n\t\t}\n\t\treq.end();\n\t});\n}\n\n// RSA password encryption\nfunction _pwdEncrypter(password, encryptionKey, timestamp) {\n\tlet rsa = new pidCrypt.RSA();\n\tlet decodedKey = pidCryptUtil.decodeBase64(encryptionKey);\n\tlet asn = pidCrypt.ASN1.decode(pidCryptUtil.toByteArray(decodedKey));\n\tlet tree = asn.toHexTree();\n\trsa.setPublicKeyFromASN(tree);\n\treturn pidCryptUtil.encodeBase64(pidCryptUtil.convertFromHex(rsa.encrypt(password + '|' + timestamp)));\n}\n\n\n// Delete request on ig api\nfunction reqMethod(type, url, version, payload) {\n\tif ([2, 3].indexOf(version) === -1) {\n\t\tversion = 1;\n\t}\n\tlet extraHeaders = {\n\t\t'x-security-token': process.env.IG_XST,\n\t\tcst: process.env.IG_CST,\n\t\t'version': version,\n\t};\n\n\tif(type == 'DELETE') {\n\t\textraHeaders = {\n\t\t\t...extraHeaders,\n\t\t\t'_method': 'DELETE' // tweek header to bypass ig API issue\n\t\t}\n\t}\n\t// IG API is not able to handle DELETE requests\n\treturn _request(type, url, payload, extraHeaders);\n}\n\n/////////////\n// ACCOUNT //\n/////////////\n\n// Log in (retrive client and session tokens)\nfunction login(encryption) {\n\t/**\n\t * Log in (retrive client and session tokens)\n\t * @param  {boolean} encryption\n\t * @return {json} \n\t */\n\treturn new Promise((res, rej) => {\n\t\tencryption = typeof(encryption) === 'undefined' ? false : encryption;\n\t\tlet tokens = {};\n\t\tlet extraHeaders = {\n\t\t\t'Version': 2\n\t\t};\n\t\tif (encryption) {\n\t\t\tconsole.log(\"Encrypted password. Here is the token expiry: \",process.env.IG_TOKENS_EXP);\n\t\t\t_request('GET', '/session/encryptionKey') // retrieve encryptionKey and timeStamp for encryption\n\t\t\t\t.then(r => {\n\n\t\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\t\trej(r);\n\t\t\t\t\t\t\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlet payload = {\n\t\t\t\t\t\t\tidentifier: process.env.IG_IDENTIFIER,\n\t\t\t\t\t\t\tpassword: _pwdEncrypter(process.env.IG_PASSWORD, r.body.encryptionKey, r.body.timeStamp), //process.env.IG_PASSWORD,\n\t\t\t\t\t\t\tencryptedPassword: true\n\t\t\t\t\t\t};\n\t\t\t\t\t\t\n\t\t\t\t\t\treturn _request('POST', '/session', payload, extraHeaders);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(r => {\n\t\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\t\trej(r);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlet igMarkets = new IGmarkets({\n\t\t\t\t\t\t\t'_id': 1,\n\t\t\t\t\t\t\t'tokens_exp': new Date().getTime() + 43200000, // tokens expire in 12h\n\t\t\t\t\t\t\t'x-request-id': r.headers['x-request-id'],\n\t\t\t\t\t\t\t'x-security-token': r.headers['x-security-token'],\n\t\t\t\t\t\t\t'cst': r.headers.cst,\n\t\t\t\t\t\t\t'lightstreamerEndpoint': r.body.lightstreamerEndpoint,\n\t\t\t\t\t\t\t'currentAccountId': r.body.currentAccountId\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t// Update the DB\n\t\t\t\t\t\tsaveTokenToDB(igMarkets)\n\t\t\t\t\t\t\t.then(result => {\n\t\t\t\t\t\t\t\t// Update the Env Vars\n\t\t\t\t\t\t\t\tsetEnvVars(\n\t\t\t\t\t\t\t\t\tigMarkets.tokens_exp,\n\t\t\t\t\t\t\t\t\tigMarkets['x-security-token'],\n\t\t\t\t\t\t\t\t\tigMarkets.cst,\n\t\t\t\t\t\t\t\t\tigMarkets.lightstreamerEndpoint\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tconsole.log(\"Env token exp val: \",process.env.IG_TOKENS_EXP);\n\t\t\t\t\t\t\t\tres(r.body);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(e => {\n\t\t\t\t\trej(e);\n\t\t\t\t});\n\t\t} else {\n\t\t\trej(\"Unencrypted password not accepted\");\n\t\t}\n\t});\n}\n\n// Log out\nfunction logout() {\n\treturn new Promise((res, rej) => {\n\t\tlet extraHeaders = {\n\t\t\t'x-security-token': process.env.IG_XST,\n\t\t\tcst: process.env.IG_CST\n\t\t};\n\t\treturn _request('DELETE', '/session', false, extraHeaders)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 204) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\n\t\t\t\t\tlet igMarkets = new IGmarkets({\n\t\t\t\t\t\t'tokens_exp': '', // tokens expire in 12h\n\t\t\t\t\t\t'x-request-id': '',\n\t\t\t\t\t\t'x-security-token': '',\n\t\t\t\t\t\t'cst': '',\n\t\t\t\t\t\t'lightstreamerEndpoint': '',\n\t\t\t\t\t\t'currentAccountId': ''\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tigMarkets.updateOne({_id:1});\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Switch Account\nfunction switchAcct(accountId) {\n\treturn new Promise((res, rej) => {\n\t\t\n\t\tlet payload = {\n\t\t\t'accountId': accountId\n\t\t};\n\t\treqMethod('PUT', '/session', 0, payload)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\n\t\t\t\t\tlet igMarkets = new IGmarkets({\n\t\t\t\t\t\t'tokens_exp': new Date().getTime() + 43200000, // tokens expire in 12h\n\t\t\t\t\t\t'x-request-id': r.headers['x-request-id'],\n\t\t\t\t\t\t'x-security-token': r.headers['x-security-token'],\n\t\t\t\t\t\t'cst': r.headers.cst,\n\t\t\t\t\t\t'currentAccountId': accountId\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tigMarkets.updateOne({_id:1});\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n//Returns a list of accounts belonging to the logged-in client\nfunction acctInfo() {\n\treturn new Promise((res, rej) => {\n\t\treqMethod('GET', '/accounts')\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Returns the account activity history\nfunction acctActivity(from, to, detailed, dealId, pageSize) {\n\treturn new Promise((res, rej) => {\n\t\t// Constraints:\n\t\tlet dateReg = /^\\d{4}([./-])\\d{2}\\1\\d{2}$/;\n\t\tif (!dateReg.test(from)) throw new Error('from has to have format: YYYY-MM-DD');\n\t\tif (!dateReg.test(to)) throw new Error('to has to have format: YYYY-MM-DD');\n\t\tif (typeof(from) === 'undefined') {\n\t\t\tfrom = '?from=1990-01-01';\n\t\t} else {\n\t\t\tfrom = '?from=' + from;\n\t\t}\n\t\tif (typeof(to) === 'undefined') {\n\t\t\tto = '&to=2099-01-01';\n\t\t} else {\n\t\t\tto = '&to=' + to;\n\t\t}\n\t\tif (typeof(detailed) === 'undefined') {\n\t\t\tdetailed = '&detailed=false';\n\t\t} else {\n\t\t\tdetailed = '&detailed=' + detailed;\n\t\t}\n\t\tif (typeof(dealId) === 'undefined') {\n\t\t\tdealId = '';\n\t\t} else {\n\t\t\tdealId = '&dealId=' + dealId;\n\t\t}\n\t\tif (typeof(pageSize) === 'undefined') {\n\t\t\tpageSize = '&pageSize=500';\n\t\t} else {\n\t\t\tpageSize = '&pageSize=' + pageSize;\n\t\t}\n\t\tlet qstring = from + to + detailed + dealId + pageSize;\n\t\treqMethod('GET', '/history/activity' + qstring, 3)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Returns the transaction history\nfunction acctTransaction(type, from, to, pageSize, pageNumber) {\n\treturn new Promise((res, rej) => {\n\t\tif (typeof(type) === 'undefined') {\n\t\t\ttype = '?type=ALL';\n\t\t} else {\n\t\t\ttype = '?type=' + type;\n\t\t} //ALL, ALL_DEAL, DEPOSIT, WITHDRAWAL\n\t\tif (typeof(from) === 'undefined') {\n\t\t\tfrom = '&from=1990-01-01';\n\t\t} else {\n\t\t\tfrom = '&from=' + from;\n\t\t}\n\t\tif (typeof(to) === 'undefined') {\n\t\t\tto = '&to=2099-01-01';\n\t\t} else {\n\t\t\tto = '&to=' + to;\n\t\t}\n\t\tif (typeof(pageSize) === 'undefined') {\n\t\t\tpageSize = '&pageSize=0';\n\t\t} else {\n\t\t\tpageSize = '&pageSize=' + pageSize;\n\t\t}\n\t\tif (typeof(pageNumber) === 'undefined') {\n\t\t\tpageNumber = '&pageNumber=0';\n\t\t} else {\n\t\t\tpageNumber = '&pageNumber=' + pageNumber;\n\t\t}\n\t\tlet qstring = type + from + to + pageSize + pageNumber;\n\t\treqMethod('GET', '/history/transactions' + qstring, 2)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// List of client-owned applications\nfunction apiInfo() {\n\treturn new Promise((res, rej) => {\n\t\treqMethod('GET', '/operations/application').\n\t\tthen(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n/////////////\n// DEALING //\n/////////////\n\n// Returns all open positions for the active account.\nfunction showOpenPositions() {\n\treturn new Promise((res, rej) => {\n\t\treqMethod('GET', '/positions')\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t});\n\t});\n}\n\n// Creates an OTC position.\nfunction deal(ticket) {\n\treturn new Promise((res, rej) => {\n\t\t// Constraints:\n\t\tif (['EUR', 'GBP', 'USD'].indexOf(ticket.currencyCode) === -1) throw new Error('currencyCode has to be EUR, GBP or USD');\n\t\tif (['BUY', 'SELL'].indexOf(ticket.direction) === -1) throw new Error('direction has to be BUY or SELL');\n\t\tif (!ticket.epic) throw new Error('epic has to be defined');\n\t\tif (!ticket.expiry) throw new Error('expiry has to be defined');\n\t\tif (!ticket.size) throw new Error('size has to be defined');\n\t\tif ([true, false].indexOf(ticket.forceOpen) === -1) throw new Error('forceOpen has to be true or false');\n\t\tif (['LIMIT', 'MARKET'].indexOf(ticket.orderType) === -1) throw new Error('orderType has to be LIMIT or MARKET');\n\t\tif ([true, false].indexOf(ticket.guaranteedStop) === -1) throw new Error('guaranteedStop has to be true or false');\n\t\tif (ticket.limitDistance !== null && ticket.forceOpen === false) throw new Error('If a limitDistance is set, then forceOpen must be true');\n\t\tif (ticket.limitLevel !== null && ticket.forceOpen === false) throw new Error('If a limitLevel is set, then forceOpen must be true');\n\t\tif (ticket.stopDistance !== null && ticket.forceOpen === false) throw new Error('If a stopDistance  is set, then forceOpen must be true');\n\t\tif (ticket.stopLevel !== null && ticket.forceOpen === false) throw new Error('If a stopLevel  is set, then forceOpen must be true');\n\t\tif (['FILL_OR_KILL', 'EXECUTE_AND_ELIMINATE'].indexOf(ticket.timeInForce) === -1) throw new Error('timeInForce has to be FILL_OR_KILL or EXECUTE_AND_ELIMINATE');\n\t\tif (ticket.stopDistance === null && ticket.stopLevel === null && ticket.guaranteedStop === true) throw new Error('If guaranteedStop equals true, then set either stopLevel or stopDistance');\n\t\tif (ticket.level === null && ticket.orderType === 'LIMIT') throw new Error('If orderType equals LIMIT, then set level');\n\t\tif (ticket.level !== null && ticket.orderType === 'MARKET') throw new Error('If orderType equals MARKET, then DO NOT set level');\n\t\tif (ticket.trailingStopIncrement !== null && ticket.trailingStop === false) throw new Error('If trailingStop equals false, then DO NOT set trailingStopIncrement');\n\t\tif (ticket.trailingStopIncrement !== null && ticket.stopLevel === false) throw new Error('If stopLevel equals false, then DO NOT set trailingStopIncrement');\n\t\tif (ticket.trailingStopIncrement === null && ticket.trailingStop === true) throw new Error('If trailingStop equals true, then set trailingStopIncrement');\n\t\tif (ticket.trailingStopIncrement === null && ticket.stopLevel === true) throw new Error('If stopLevel equals true, then set trailingStopIncrement');\n\t\tif (ticket.trailingStop === true && ticket.guaranteedStop === true) throw new Error('If trailingStop equals true, then guaranteedStop must be false');\n\t\tif (ticket.limitLevel !== null && ticket.limitDistance !== null) throw new Error('Set only one of limitLevel or limitDistance');\n\t\tif (ticket.stopLevel !== null && ticket.stopDistance !== null) throw new Error('Set only one of stopLevel or stopDistance');\n\t\tlet response = {};\n\t\treqMethod('POST','/positions/otc', 2, ticket)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tresponse.positions = r.body;\n\t\t\t\t\treturn reqMethod('GET', '/confirms/' + r.body.dealReference);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(r => {\n\t\t\t\t// no need to reject if confirmation request fails\n\t\t\t\tresponse.confirms = r.body;\n\t\t\t\tres(response);\n\t\t\t})\n\t\t\t.catch(e => rej(e));\n\t});\n}\n\n// Attach order to open position\nfunction editPosition(dial_id, ticket) {\n\t// [Constraint: If trailingStop equals false, then DO NOT set trailingStopDistance,trailingStopIncrement]\n\t// [Constraint: If trailingStop equals true, then set trailingStopDistance,trailingStopIncrement,stopLevel]\n\treturn new Promise((res, rej) => {\n\t\treqMethod('PUT', '/positions/otc/' + dial_id, 2, ticket)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\treturn reqMethod('GET', '/confirms/' + r.body.dealReference);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(r => {\n\t\t\t\tres(r.body);\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Closes an open position\nfunction closePosition(dealId) {\n\treturn new Promise((res, rej) => {\n\t\tlet temp1 = [];\n\t\tlet response = {};\n\t\treqMethod('GET', '/positions', 2)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tlet temp2 = r.body.positions;\n\t\t\t\t\tfor (let i = 0; i < temp2.length; i++) {\n\t\t\t\t\t\ttemp1[temp2[i].position.dealId] = [\n\t\t\t\t\t\t\ttemp2[i].market.epic,\n\t\t\t\t\t\t\ttemp2[i].market.expiry,\n\t\t\t\t\t\t\ttemp2[i].position.direction,\n\t\t\t\t\t\t\ttemp2[i].position.size,\n\t\t\t\t\t\t\ttemp2[i].position.currency,\n\t\t\t\t\t\t\ttemp2[i].market.marketStatus,\n\t\t\t\t\t\t\ttemp2[i].market.streamingPricesAvailable,\n\t\t\t\t\t\t\ttemp2[i].market.bid,\n\t\t\t\t\t\t\ttemp2[i].market.offer\n\t\t\t\t\t\t];\n\t\t\t\t\t}\n\t\t\t\t\tlet ticket = {\n\t\t\t\t\t\t// you can close a position by 1) dealId (exact position) or 2) epic + expiry (FIFO)\n\t\t\t\t\t\t'dealId': dealId,\n\t\t\t\t\t\t'direction': temp1[dealId][2] === 'BUY' ? 'SELL' : 'BUY', // invert to opposite side\n\t\t\t\t\t\t// 'epic' : temp1[dealId][0],\n\t\t\t\t\t\t// 'expiry': temp1[dealId][1],\n\t\t\t\t\t\t'orderType': 'MARKET',\n\t\t\t\t\t\t'size': temp1[dealId][3]\n\t\t\t\t\t};\n\t\t\t\t\treturn reqMethod('DELETE', '/positions/otc', 2, ticket);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tresponse.positions = r.body;\n\t\t\t\t\treturn reqMethod('GET', '/confirms/' + r.body.dealReference);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(r => {\n\t\t\t\tresponse.confirms = r.body;\n\t\t\t\tres(response);\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Closes all open positions\nfunction closeAllPositions() {\n\treturn new Promise((res, rej) => {\n\t\tlet response = [];\n\t\tlet tickets = [];\n\t\tlet index = 0;\n\t\treqMethod('GET','/positions', 2)\n\t\t\t.then(r => {\n\t\t\t\tlet temp = r.body.positions;\n\t\t\t\tif (temp.length === 0)(res('There is no position to close'));\n\t\t\t\tfor (let i = 0; i < temp.length; i++) {\n\t\t\t\t\ttickets.push({\n\t\t\t\t\t\t'dealId': temp[i].position.dealId, // to be tested\n\t\t\t\t\t\t'direction': temp[i].position.direction === 'BUY' ? 'SELL' : 'BUY', // invert to opposite side\n\t\t\t\t\t\t// 'epic' : temp[i].market.epic,\n\t\t\t\t\t\t// 'expiry': temp[i].market.expiry,\n\t\t\t\t\t\t'orderType': 'MARKET',\n\t\t\t\t\t\t'size': temp[i].position.size\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tfunction _close(index) {\n\t\t\t\t\tif (tickets[index]) {\n\t\t\t\t\t\treqMethod('DELETE','/positions/otc', 0, tickets[index])\n\t\t\t\t\t\t\t.then(r => {\n\t\t\t\t\t\t\t\treqMethod('GET', '/confirms/' + r.body.dealReference)\n\t\t\t\t\t\t\t\t\t.then(r => {\n\t\t\t\t\t\t\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\t\t\t\t\t\t\trej(r);\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\tindex++;\n\t\t\t\t\t\t\t\t\t\t\t_close(index);\n\t\t\t\t\t\t\t\t\t\t\tresponse.push(r.body);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.catch(e => {\n\t\t\t\t\t\t\t\t\t\trej(e);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(e => {\n\t\t\t\t\t\t\t\trej(e);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tres(response);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t_close(index);\n\t\t\t}); // end .then\n\t}); // end promise\n}\n\n////////////////////\n// WORKING ORDERS //\n////////////////////\n\n// Returns all open working orders for the active account.\nfunction showWorkingOrders() {\n\treturn new Promise((res, rej) => {\n\t\treqMethod('GET', '/workingorders')\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Create working order\nfunction createOrder(ticket) {\n\treturn new Promise((res, rej) => {\n\t\t// Constraints:\n\t\tif (['EUR', 'GBP', 'USD'].indexOf(ticket.currencyCode) === -1) throw new Error('currencyCode has to be EUR, GBP or USD');\n\t\tif (['BUY', 'SELL'].indexOf(ticket.direction) === -1) throw new Error('direction has to be BUY or SELL');\n\t\tif (!ticket.epic) throw new Error('epic has to be defined');\n\t\tif (!ticket.expiry) throw new Error('expiry has to be defined');\n\t\tif (!ticket.size) throw new Error('size has to be defined');\n\t\tif ([true, false].indexOf(ticket.forceOpen) === -1) throw new Error('forceOpen has to be true or false');\n\t\tif (['LIMIT', 'STOP'].indexOf(ticket.type) === -1) throw new Error('type has to be LIMIT or STOP');\n\t\tif ([true, false].indexOf(ticket.guaranteedStop) === -1) throw new Error('guaranteedStop has to be true or false');\n\t\tif (ticket.limitDistance != null && ticket.forceOpen === false) throw new Error('If a limitDistance is set, then forceOpen must be true');\n\t\tif (ticket.limitLevel != null && ticket.forceOpen === false) throw new Error('If a limitLevel is set, then forceOpen must be true');\n\t\tif (ticket.stopDistance != null && ticket.forceOpen === false) throw new Error('If a stopDistance  is set, then forceOpen must be true');\n\t\tif (ticket.stopLevel != null && ticket.forceOpen === false) throw new Error('If a stopLevel  is set, then forceOpen must be true');\n\t\tif (['GOOD_TILL_CANCELLED', 'GOOD_TILL_DATE'].indexOf(ticket.timeInForce) === -1) throw new Error('timeInForce has to be GOOD_TILL_CANCELLED or GOOD_TILL_DATE');\n\t\tif (ticket.stopDistance === null && ticket.stopLevel === null && ticket.guaranteedStop === true) throw new Error('If guaranteedStop equals true, then set either stopLevel or stopDistance');\n\t\tif (ticket.level === null) throw new Error('level has to be defined');\n\t\tif (ticket.limitLevel != null && ticket.limitDistance != null) throw new Error('Set only one of limitLevel or limitDistance');\n\t\tif (ticket.stopLevel != null && ticket.stopDistance != null) throw new Error('Set only one of stopLevel or stopDistance');\n\t\treqMethod('POST','/workingorders/otc', 2, ticket)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\treturn reqMethod('GET','/confirms/' + r.body.dealReference);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(r => {\n\t\t\t\tres(r.body);\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Delete existing working order\nfunction deleteOrder(dealId) {\n\tlet response = {};\n\treturn new Promise((res, rej) => {\n\t\tlet close = {};\n\t\treqMethod('DELETE', '/workingorders/otc/' + dealId, 0, close)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tresponse.workingorders = r.body;\n\t\t\t\t\treturn reqMethod('GET','/confirms/' + r.body.dealReference);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(r => {\n\t\t\t\tresponse.confirms = r.body;\n\t\t\t\tres(response);\n\t\t\t})\n\t\t\t.catch(e => rej(e));\n\t});\n}\n\n// Delete all existing working orders\nfunction deleteAllOrders() {\n\treturn new Promise((res, rej) => {\n\t\tlet response = [];\n\t\tlet tickets = [];\n\t\tlet index = 0;\n\t\tlet close = {};\n\t\treqMethod('GET','/workingorders')\n\t\t\t.then(r => {\n\t\t\t\tlet temp = r.body.workingOrders;\n\t\t\t\tif (temp.length === 0)(res('There is no order to close'));\n\t\t\t\tfor (let i = 0; i < temp.length; i++) {\n\t\t\t\t\ttickets.push(temp[i].workingOrderData.dealId);\n\t\t\t\t}\n\n\t\t\t\tfunction _close(index) {\n\t\t\t\t\tif (tickets[index]) {\n\t\t\t\t\t\treqMethod('/workingorders/otc/' + tickets[index], 0, close)\n\t\t\t\t\t\t\t.then(r => {\n\t\t\t\t\t\t\t\treqMethod('GET','/confirms/' + r.body.dealReference)\n\t\t\t\t\t\t\t\t\t.then(r => {\n\t\t\t\t\t\t\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\t\t\t\t\t\t\trej(r);\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\tindex++;\n\t\t\t\t\t\t\t\t\t\t\t_close(index);\n\t\t\t\t\t\t\t\t\t\t\tresponse.push(r.body);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.catch(e => {\n\t\t\t\t\t\t\t\t\t\trej(e);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(e => {\n\t\t\t\t\t\t\t\trej(e);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tres(response);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t_close(index);\n\n\t\t\t});\n\t});\n}\n\n/////////////\n// MARKETS //\n/////////////\n\n// Search a contract\nfunction search(searchTerm) {\n\treturn new Promise((res, rej) => {\n\t\tlet extraHeaders = {\n\t\t\t'x-security-token': process.env.IG_XST,\n\t\t\tcst: process.env.IG_CST\n\t\t};\n\t\treqMethod('GET','/markets?searchTerm=' + searchTerm, false, extraHeaders)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Client sentiment (ig volume)\nfunction igVolume(epics) {\n\treturn new Promise((res, rej) => {\n\t\tif (epics.length > 50) throw new Error('Max number of epics is limited to 50');\n\t\tlet qstringEpics = '?epics=';\n\t\tepics.map(epic => {\n\t\t\tqstringEpics = qstringEpics + epic + '%2c';\n\t\t});\n\t\tqstringEpics = qstringEpics.slice(0, qstringEpics.length - 3);\n\t\treqMethod('GET','/markets' + qstringEpics)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tlet marketDetails = r.body.marketDetails;\n\t\t\t\t\tlet qstringMaketId = '?marketIds=';\n\t\t\t\t\tfor (var i = 0; i < marketDetails.length; i++) {\n\t\t\t\t\t\tqstringMaketId = qstringMaketId + marketDetails[i].instrument.marketId + '%2c';\n\t\t\t\t\t}\n\t\t\t\t\tqstringMaketId = qstringMaketId.slice(0, qstringMaketId.length - 3);\n\t\t\t\t\treturn reqMethod('GET','/clientsentiment' + qstringMaketId);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(r => {\n\t\t\t\tres(r.body);\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Market node content\nfunction marketNode(id) {\n\treturn new Promise((res, rej) => {\n\t\tlet url = typeof(id) === 'undefined' ? '/marketnavigation' : '/marketnavigation/' + id;\n\t\treqMethod('GET', url)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else(res(r.body));\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Historical prices\nfunction histPrc(epic, resolution, from, to) {\n\n\t/**\n\t * @param {string} epic \n\t * @param {string} resolution\n\t *\tPermitted values are: DAY, HOUR, HOUR_2, HOUR_3, HOUR_4, MINUTE, MINUTE_10, MINUTE_15, MINUTE_2, MINUTE_3, \n\t *\tMINUTE_30, MINUTE_5, MONTH, SECOND, WEEK\n\t * @param {from} string\n\t *\tPermitted values are: \n\t *\t* @param {to} string\n\t * Permitted values are:\n\t */\n\n\treturn new Promise((res, rej) => {\n\t\treqMethod('GET', '/prices/' + epic + '?resolution=' + resolution + '&startdate=' + from + '&to=' + to, 3)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Epic details\nfunction epicDetails(epics) {\n\t/**\n\t * @param {array} epics -\tArray of epics (max 50)\n\t */\n\tif (epics.length > 50) throw new Error('Max number of epics is limited to 50');\n\treturn new Promise((res, rej) => {\n\t\tlet qstringEpics = '?epics=';\n\t\tepics.map(epic => {\n\t\t\tqstringEpics = qstringEpics + epic + '%2c';\n\t\t});\n\t\tqstringEpics = qstringEpics.slice(0, qstringEpics.length - 3);\n\t\treqMethod('GET', '/markets' + qstringEpics)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n///////////////\n// WATCHLIST //\n///////////////\n\n// Watchlists summary and watchlist content\nfunction watchlists(id) {\n\treturn new Promise((res, rej) => {\n\t\tif (typeof(id) === 'undefined') {\n\t\t\treqMethod('GET', '/watchlists')\n\t\t\t\t.then(r => {\n\t\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\t\trej(r);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tres(r.body.watchlists);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(e => {\n\t\t\t\t\trej(e);\n\t\t\t\t});\n\t\t} else {\n\t\t\treqMethod('GET','/watchlists/' + id)\n\t\t\t\t.then(r => {\n\t\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\t\trej(r);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tres(r.body);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(e => {\n\t\t\t\t\trej(e);\n\t\t\t\t});\n\t\t}\n\t});\n}\n\n// Create a new watchlist\nfunction createWatchlist(name, epics) {\n\treturn new Promise((res, rej) => {\n\t\tlet payload = {\n\t\t\t'epics': epics,\n\t\t\t'name': name\n\t\t};\n\t\treqMethod('POST','/watchlists',0, payload)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Delete entire watchlist\nfunction deleteWatchlist(id) {\n\treturn new Promise((res, rej) => {\n\t\tlet payload = {};\n\t\treqMethod('/watchlists/' + id, 0, payload)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Insert single epic to watchlist\nfunction addEpicWatchlist(epic, watchlistID) {\n\treturn new Promise((res, rej) => {\n\t\tlet payload = {\n\t\t\t'epic': epic\n\t\t};\n\t\treqMethod('PUT', '/watchlists/' + watchlistID, 0, payload)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n// Remove single epic to watchlist\nfunction removeEpicWatchlist(epic, watchlistID) {\n\treturn new Promise((res, rej) => {\n\t\tlet payload = {};\n\t\treqMethod('DELETE', '/watchlists/' + watchlistID + '/' + epic, 0, payload)\n\t\t\t.then(r => {\n\t\t\t\tif (r.status !== 200) {\n\t\t\t\t\trej(r);\n\t\t\t\t} else {\n\t\t\t\t\tres(r.body);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\trej(e);\n\t\t\t});\n\t});\n}\n\n///////////////////\n// LIGHTSTREAMER //\n///////////////////\n\n// Connect to lightstreamer\nfunction connectToLightstreamer() {\n\n\t// include the Lightstreamer LightstreamerClient module using requirejs\n\trequirejs(['LightstreamerClient'], function(LightstreamerClient) {\n\n\t\t// Instantiate Lightstreamer client instance\n\t\tlsClient = new LightstreamerClient(process.env.IG_LIGHTSTREAMER_END_POINT);\n\n\t\t// Set up login credentials\n\t\tlsClient.connectionDetails.setUser(process.env.IG_CURRENT_ACCT_ID);\n\t\tlsClient.connectionDetails.setPassword('CST-' + process.env.IG_CST + '|XST-' + process.env.IG_XST);\n\n\t\t// Add connection event listener callback functions\n\t\t// Note: the Lightstreamer library will transparently attempt to reconnect a number of times\n\t\t// in the event of communicationss errors\n\t\tlsClient.addListener({\n\t\t\tonListenStart: () => {\n\t\t\t\tconsole.log('Attempting connection to Lightstreamer');\n\t\t\t},\n\t\t\tonStatusChange: status => {\n\t\t\t\tconsole.log('Lightstreamer connection status: ' + status);\n\t\t\t},\n\t\t\tonServerError: (errorCode, errorMessage) => {\n\t\t\t\tconsole.log('Lightstreamer error: ' + errorCode + ' message: ' + errorMessage);\n\t\t\t\tconnectToLightstreamer();\n\t\t\t}\n\t\t});\n\n\t\t// Connect to Lightstreamer\n\t\tlsClient.connect();\n\n\t});\n}\n\n// Subscribe to lightstreamer\nfunction subscribeToLightstreamer(subscriptionMode, items, fields, maxFreq) {\n\t/**\n\t * @param {string} subscriptionMode \n\t *\tPermitted values are: MERGE, DISTINCT, RAW, COMMAND\n\t * @param {array} items\n\t *\tArray of epics with format: 'L1:'+epics\n\t * @param {fields} fields\n\t *\tPermitted values are: MID_OPEN, HIGH, LOW, CHANGE, CHANGE_PCT, UPDATE_TIME, MARKET_DELAY, MARKET_STATE, BID, OFFER, \n\t *\tSTRIKE_PRICE, ODDS\n\t * @param {number} maxFreq\n\t *\tNumber of max updated per second\n\t */\n\tif (Object.getOwnPropertyNames(lsClient).length !== 0) {\n\t\tthrow new Error('Lightstreamer is not connected');\n\t}\n\n\t// include the Lightstreamer Subscription module using requirejs\n\trequirejs(['Subscription'], function(Subscription) {\n\n\t\tlet str = [];\n\t\tlet colNames = ['RUN_TIME', 'EPIC'].concat(fields);\n\t\tstr.push(colNames);\n\t\t// str.push(os.EOL);\n\n\t\tsubscription = new Subscription(subscriptionMode, items, fields);\n\n\t\tsubscription.setRequestedMaxFrequency(maxFreq);\n\n\t\t\t// Set up Lightstreamer event listener\n\t\t\tsubscription.addListener({\n\n\t\t\t\tonSubscription: function() {\n\t\t\t\t\tconsole.log('Subscribed to: ' + items);\n\t\t\t\t},\n\n\t\t\t\tonUnsubscription: function() {\n\t\t\t\t\tconsole.log('Unsubscribed');\n\t\t\t\t},\n\n\t\t\t\tonSubscriptionError: (code, message) => {\n\t\t\t\t\tconsole.log('Subscription failure: ' + code + ' message: ' + message);\n\t\t\t\t},\n\n\t\t\t\tonItemLostUpdates: () => {\n\t\t\t\t\tconsole.log('Update item lost');\n\t\t\t\t},\n\n\t\t\t\tonItemUpdate: updateInfo => {\n\t\t\t\t\tvar coeff = 1000 * 60 * 1;\n\t\t\t\t\tvar date = new Date();  //or use any other date\n\t\t\t\t\tvar rounded = new Date(Math.round(date.getTime() / coeff) * coeff);\n\t\t\t\t\tstr = {\n\t\t\t\t\t\tepic_settings: updateInfo.By\n\t\t\t\t\t};\n\n\t\t\t\t\t// Keep the last [period] of OHLC records. eg 100. The unit is 1MINUTE as that is the smallest unit. Minimum period is 20.\n\t\t\t\t\t// Update the 5M, 10M, 15M, 30M, 1HR, 2HR, 4HR, 1D records\n\t\t\t\t\t/*\n\t\t\t\t\t\t5M = Last 5 minute block requires the relevant OHLC data.\n\t\t\t\t\t\t10M = Take last 10 minute block to get the relevant OHLC data.\n\t\t\t\t\t\t\n\t\t\t\t\t*/\n\n\t\t\t\t\tupdateInfo.forEachField((fieldName, fieldPos, value) => {\n\t\t\t\t\t\tstr[fieldName] = value;\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tlet price = new Prices(str);\n\n\n\t\t\t\t\t//console.log(price);\n\t\t\t\t\tif(str.CONS_END == true) {\n\t\t\t\t\t\tstr[\"minute\"] = rounded;\n\n\t\t\t\t\t\tprice.save(str);\n\t\t\t\t\t\tconsole.log(`(UTM ${str.UTM}): inserted ${str.BID_CLOSE} into ${str.epic_settings}. CONS: ${str['CONS_END']}`);\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t});\n\n\t\t//});\n\n\t\t// Subscribe to Lightstreamer\n\t\tlsClient.subscribe(subscription);\n\n\t});\n}\n\nmodule.exports = {\n\treqMethod: reqMethod,\n\tlogin: login,\n\tlogout: logout,\n\tswitchAcct: switchAcct,\n\tacctInfo: acctInfo,\n\tacctActivity: acctActivity,\n\tacctTransaction: acctTransaction,\n\tshowOpenPositions: showOpenPositions,\n\tshowWorkingOrders: showWorkingOrders,\n\tdeal: deal,\n\tclosePosition: closePosition,\n\tcloseAllPositions: closeAllPositions,\n\tcreateOrder: createOrder,\n\teditPosition: editPosition,\n\tdeleteOrder: deleteOrder,\n\tdeleteAllOrders: deleteAllOrders,\n\tsearch: search,\n\tigVolume: igVolume,\n\tmarketNode: marketNode,\n\twatchlists: watchlists,\n\tcreateWatchlist: createWatchlist,\n\tdeleteWatchlist: deleteWatchlist,\n\taddEpicWatchlist: addEpicWatchlist,\n\tremoveEpicWatchlist: removeEpicWatchlist,\n\tapiInfo: apiInfo,\n\thistPrc: histPrc,\n\tconnectToLightstreamer: connectToLightstreamer,\n\tsubscribeToLightstreamer: subscribeToLightstreamer,\n\tepicDetails: epicDetails,\n\tinitiateToken: initiateToken\n};"],"file":"node-ig-api.js"}